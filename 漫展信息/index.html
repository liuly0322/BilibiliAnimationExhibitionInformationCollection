<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bilibili æ¼«å±•ä¿¡æ¯æ”¶é›†</title>
  </head>
  <body>
    <style>
      a {
        color: black;
      }
      #autoUpdateStatus,
      #citySelectDiv {
        margin-bottom: 1em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #4caf50;
        color: white;
      }
      details {
        border: 1px solid #ddd;
        padding: 0.5em;
        margin-bottom: 1em;
        background-color: #f9f9f9;
      }
      summary {
        font-weight: bold;
        margin: -0.5em -0.5em 0;
        padding: 0.5em;
      }
      details[open] {
        padding: 0.5em;
      }
      details[open] summary {
        border-bottom: 1px solid #ddd;
        margin-bottom: 0.5em;
      }
      @media screen and (max-width: 600px) {
        table {
          width: 100%;
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
      }
    </style>
    <h1>Bilibili æ¼«å±•ä¿¡æ¯æ”¶é›†</h1>

    <div id="autoUpdateStatus">
      <span id="updateTime"></span>ï¼ˆ<a
        href="https://github.com/liuly0322/BilibiliAnimationExhibitionInformationCollection/actions/workflows/auto_update.yml"
        >GitHub Actions</a
      >ï¼‰
    </div>
    <script>
      // fetch timestamp.txt to get the last update time
      fetch("timestamp.txt")
        .then((response) => response.text())
        .then((data) => {
          time = new Date(Number(data) * 1000).toLocaleString();
          document.getElementById(
            "updateTime"
          ).innerHTML = `æœ€åæ›´æ–°æ—¶é—´ï¼š${time}`;
        })
        .catch((error) => {
          document.getElementById(
            "updateTime"
          ).innerHTML = `Error loading timestamp.txt: ${error}`;
        });
    </script>

    <div id="citySelectDiv">
      é€‰æ‹©åŸå¸‚ï¼š<select id="citySelect">
        <option value="ä¸Šæµ·">ä¸Šæµ·</option>
        <option value="æ­å·">æ­å·</option>
        <option value="è‹å·">è‹å·</option>
        <option value="åŒ—äº¬">åŒ—äº¬</option>
        <option value="ä¸½æ°´">ä¸½æ°´</option>
        <option value="å¹¿å·">å¹¿å·</option>
        <option value="åˆè‚¥">åˆè‚¥</option>
        <option value="å—å®">å—å®</option>
      </select>
    </div>

    <div id="jsonDisplay"></div>
    <script>
      const citySelect = document.getElementById("citySelect");
      const jsonDisplay = document.getElementById("jsonDisplay");
      const updateJsonDisplay = () => {
        const hiddenKeys = ["Link", "æ˜¯å¦æœ‰èˆå°ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰"];
        const keyHandlers = {
          åç§°: (tableCell, exhibition) => {
            const link = document.createElement("a");
            link.href = exhibition["Link"];
            link.innerHTML = exhibition["åç§°"];
            tableCell.appendChild(link);
          },
          åœ°ç‚¹: (tableCell, exhibition) => {
            // if æ˜¯å¦æœ‰èˆå°ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰is true, add a ğŸ¤ emoji
            if (exhibition["æ˜¯å¦æœ‰èˆå°ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰"] === true) {
              tableCell.innerHTML = `${exhibition["åœ°ç‚¹"]} ğŸ¤`;
            } else {
              tableCell.innerHTML = exhibition["åœ°ç‚¹"];
            }
          },
          å…·ä½“æ—¶é—´èŒƒå›´: (tableCell, exhibition) => {
            const timeRange = exhibition["å…·ä½“æ—¶é—´èŒƒå›´"];
            // replace all "yyyy.mm.dd" to "mm.dd"
            const timeRangeShort = timeRange.replace(
              /\d{4}\.\d{2}\.\d{2}/g,
              (match) => {
                return match.slice(5);
              }
            );
            tableCell.innerHTML = timeRangeShort;
          },
        };

        const selectedCity = citySelect.value;
        const jsonFilePath = `${selectedCity}-æ¼«å±•ä¿¡æ¯.json`;

        fetch(jsonFilePath)
          .then((response) => response.json())
          .then((data) => {
            jsonDisplay.innerHTML = "";
            // <details> and <summary> for each kind of exhibition
            for (const exhibitionKind in data) {
              const exhibitionKindDetails = document.createElement("details");
              const exhibitionKindSummary = document.createElement("summary");
              exhibitionKindSummary.innerHTML = exhibitionKind;
              exhibitionKindDetails.appendChild(exhibitionKindSummary);
              exhibitions = data[exhibitionKind]; // a array of exhibition info in k-v object
              // extract the keys of the first exhibition as the table header
              const tableHeader = document.createElement("tr");
              for (const key in exhibitions[0]) {
                if (hiddenKeys.includes(key)) {
                  continue;
                }
                const tableHeaderCell = document.createElement("th");
                tableHeaderCell.innerHTML = key;
                tableHeader.appendChild(tableHeaderCell);
              }
              // <table> for each kind of exhibition
              const table = document.createElement("table");
              table.appendChild(tableHeader);
              // <tr> and <td> for each exhibition
              for (const exhibition of exhibitions) {
                const tableRow = document.createElement("tr");
                for (const key in exhibition) {
                  if (hiddenKeys.includes(key)) {
                    continue;
                  }
                  const tableCell = document.createElement("td");
                  if (key in keyHandlers) {
                    keyHandlers[key](tableCell, exhibition);
                  } else {
                    tableCell.innerHTML = exhibition[key];
                  }
                  tableRow.appendChild(tableCell);
                }
                table.appendChild(tableRow);
              }
              exhibitionKindDetails.appendChild(table);
              jsonDisplay.appendChild(exhibitionKindDetails);
            }
          })
          .catch((error) => {
            console.log(error);
            jsonDisplay.innerHTML = `Error loading JSON: ${error}`;
          });
      };
      citySelect.addEventListener("change", () => {
        // remember the selected city in localStorage
        localStorage.setItem("selectedCity", citySelect.value);
        updateJsonDisplay();
      });
      // load the selected city from localStorage
      citySelect.value = localStorage.getItem("selectedCity") || "ä¸Šæµ·";
      updateJsonDisplay();
    </script>

    <script
      async
      src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
    ></script>
    <p>
      <span id="busuanzi_container_page_pv">
        æ€»è®¿é—®é‡ <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    </p>
  </body>
</html>
